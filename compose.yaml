services:
    libretranslate:
        image: libretranslate/libretranslate:latest
        container_name: libretranslate
        restart: unless-stopped
        ports:
            - "5000:5000"
        environment:
            LT_LOAD_ONLY: en,pl,cs,de,es,fr,hu,nl,ro,sk,sv,ru,uk,it # ogranicz języki → szybszy start i mniejsze zużycie RAM
            LT_UPDATE_MODELS: "true"        # katalog modeli
            LT_REQ_LIMIT: "0"               # limit zapytań (0 = brak limitu)
            LT_MAX_TEXT_LENGTH: "5000"      # maksymalny rozmiar tekstu
            LT_THREADS: "4"                 # wątki serwera WSGI (domyślnie 4)
        volumes:
            - libretranslate_models:/home/libretranslate/.local
        networks:
            devapp:
        deploy:
            resources:
                limits:
                    memory: 2g
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:5000/languages" ]
            interval: 30s
            timeout: 10s
            retries: 3

    nllb-translator:
        image: python:3.11-slim
        container_name: nllb-translator
        restart: unless-stopped
        ports:
            - "8081:8000"
        working_dir: /app
        volumes:
            - nllb_models:/models
            - ./nllb:/app
        networks:
            devapp:
        environment:
            MODEL_NAME: facebook/nllb-200-distilled-600M
            HF_HOME: /models
            TRANSFORMERS_CACHE: /models
        command: >
            bash -c "
            pip install --no-cache-dir fastapi uvicorn transformers sentencepiece torch &&
            uvicorn server:app --host 0.0.0.0 --port 8000
            "
        deploy:
            resources:
                limits:
                    memory: 3g

    php:
        build:
            context: .
            target: dev
            args:
                APP_USER_ID: 1000
                APP_USER_NAME: appuser
        restart: on-failure
        ports:
            - "8080:8080"
        volumes:
            - .docker/php/php.ini:/usr/local/etc/php/conf.d/app-overrides.ini
            - ./:/app/
            - home_appuser:/home/appuser/
        environment:
            PHP_IDE_CONFIG: "serverName=dev"
        working_dir: /app
        tty: true
        networks:
            devapp:
        extra_hosts:
            - host.docker.internal:host-gateway

volumes:
    libretranslate_models:
    nllb_models:
    home_appuser:

networks:
    devapp:
